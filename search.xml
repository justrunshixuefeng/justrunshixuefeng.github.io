<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>linux find</title>
      <link href="/2019/12/10/linux-find%20/"/>
      <url>/2019/12/10/linux-find%20/</url>
      
        <content type="html"><![CDATA[<p>[TOC]</p><h3 id="find命令格式："><a href="#find命令格式：" class="headerlink" title="find命令格式："></a>find命令格式：</h3><p>find   path  -option  【 -print 】  【 -exec   -ok   |xargs  |grep  】 【  command  {} ;  】</p><a id="more"></a><hr><p>find命令的参数：</p><ol><li><p>path：要查找的目录路径。 </p><blockquote><p>  ~ 表示$HOME目录<br>   . 表示当前目录<br>   / 表示根目录 </p></blockquote></li><li><p>print：表示将结果输出到标准输出。</p></li><li><p>exec：对匹配的文件执行该参数所给出的shell命令。 </p><pre><code>形式为command {} \;，注意{}与\;之间有空格 </code></pre></li><li><p>ok：与exec作用相同，</p><pre><code>区别在于，在执行命令之前，都会给出提示，让用户确认是否执行 </code></pre></li><li><p>|xargs  与exec作用相同 ，起承接作用</p><p>区别在于 |xargs 主要用于承接删除操作 ，而 -exec 都可用 如复制、移动、重命名等</p></li><li><p>options ：表示查找方式</p><blockquote><p>options常用的有下选项：</p><p>-name   filename               #查找名为filename的文件<br>-perm                                #按执行权限来查找<br>-user    username             #按文件属主来查找<br>-group groupname            #按组来查找<br>-mtime   -n +n                   #按文件更改时间来查找文件，-n指n天以内，+n指n天以前<br>-atime    -n +n                   #按文件访问时间来查找文件，-n指n天以内，+n指n天以前<br>-ctime    -n +n                  #按文件创建时间来查找文件，-n指n天以内，+n指n天以前<br>-nogroup                          #查无有效属组的文件，即文件的属组在/etc/groups中不存在<br>-nouser                            #查无有效属主的文件，即文件的属主在/etc/passwd中不存<br>-type    b/d/c/p/l/f             #查是块设备、目录、字符设备、管道、符号链接、普通文件<br>-size      n[c]                    #查长度为n块[或n字节]的文件<br>-mount                            #查文件时不跨越文件系统mount点<br>-follow                            #如果遇到符号链接文件，就跟踪链接所指的文件<br>-prune                            #忽略某个目录</p></blockquote></li></ol><hr><p>下面通过一些简单的例子来介绍下find的常规用法： </p><h4 id="1、按名字查找"><a href="#1、按名字查找" class="headerlink" title="1、按名字查找"></a>1、按名字查找</h4><pre><code>在当前目录及子目录中，查找大写字母开头的txt文件  $ find . -name &apos;[A-Z]*.txt&apos; -print 　　在/etc及其子目录中，查找host开头的文件 $ find /etc -name &apos;host*&apos; -print 　　在$HOME目录及其子目录中，查找所有文件 　　$ find ~ -name &apos;*&apos; -print 在当前目录及子目录中，查找不是out开头的txt文件 　　$ find . -name &quot;out*&quot; -prune -o -name &quot;*.txt&quot; -print </code></pre><h4 id="2、按目录查找"><a href="#2、按目录查找" class="headerlink" title="2、按目录查找 　　"></a>2、按目录查找 　　</h4><pre><code>在当前目录除aa之外的子目录内搜索 txt文件 　　$ find . -path &quot;./aa&quot; -prune -o -name &quot;*.txt&quot; -print 　　在当前目录及除aa和bb之外的子目录中查找txt文件 　　$ find . −path′./dir0′−o−path′./dir1′−path′./dir0′−o−path′./dir1′ -a -prune -o -name &apos;*.txt&apos; -print</code></pre><p>注意：在1、2处都需要加空格，否则会出现如图所示的报错</p><pre><code>      在3处加不加 -a都可以 在当前目录，不再子目录中，查找txt文件  $ find . ! -name &quot;.&quot; -type d -prune -o -type f -name &quot;*.txt&quot; -print 或者   find . -name *.txt -type f -print</code></pre><p>友情链接：Linux中find命令-path -prune用法详解</p><h4 id="3、按权限查找"><a href="#3、按权限查找" class="headerlink" title="3、按权限查找 　　"></a>3、按权限查找 　　</h4><p>​      </p><pre><code>在当前目录及子目录中，查找属主具有读写执行，其他具有读执行权限的文件 　　$ find . -perm 755 -print 查找用户有写权限或者组用户有写权限的文件或目录find ./ -perm /220find ./ -perm /u+w,g+wfind ./ -perm /u=w,g=w</code></pre><h4 id="4、按类型查找-（b-d-c-p-l-f-）"><a href="#4、按类型查找-（b-d-c-p-l-f-）" class="headerlink" title="4、按类型查找 　（b/d/c/p/l/f ）　"></a>4、按类型查找 　（b/d/c/p/l/f ）　</h4><pre><code>在当前目录及子目录下，查找符号链接文件 　　$ find . -type l -print </code></pre><h4 id="5、按属主及属组"><a href="#5、按属主及属组" class="headerlink" title="5、按属主及属组 　　"></a>5、按属主及属组 　　</h4><pre><code>查找属主是www的文件 　　$ find / -user www -type f -print 　　查找属主被删除的文件 $ find / -nouser -type f -print 　　查找属组 mysql 的文件 $ find / -group mysql -type f -print 　　查找用户组被删掉的文件 $ find / -nogroup -type f -print </code></pre><h4 id="6、按时间查找"><a href="#6、按时间查找" class="headerlink" title="6、按时间查找 　　"></a>6、按时间查找 　　</h4><pre><code>查找2天内被更改过的文件  $ find . -mtime -2 -type f -print 　　查找2天前被更改过的文件 $ find . -mtime +2 -type f -print 　　查找一天内被访问的文件 $ find . -atime -1 -type f -print 　　查找一天前被访问的文件 $ find . -atime +1 -type f -print 　　查找一天内状态被改变的文件 $ find . -ctime -1 -type f -print 　　查找一天前状态被改变的文件 $ find . -ctime +1 -type f -print 　　查找10分钟以前状态被改变的文件 $ find . -cmin +10 -type f -print </code></pre><h4 id="7、按文件新旧"><a href="#7、按文件新旧" class="headerlink" title="7、按文件新旧 　　"></a>7、按文件新旧 　　</h4><p>​      </p><pre><code>查找比 aa.txt 新的文件 $ find . -newer &quot;aa.txt&quot; -type f -print 　　查找比 aa.txt 旧的文件 $ find . ! -newer &quot;aa.txt&quot; -type f -print 　　查找比aa.txt新，比bb.txt旧的文件 $ find . -newer &apos;aa.txt&apos; ! -newer &apos;bb.txt&apos; -type f -print </code></pre><h4 id="8、按大小查找"><a href="#8、按大小查找" class="headerlink" title="8、按大小查找 　　"></a>8、按大小查找 　　</h4><pre><code>查找超过1M的文件 $ find / -size +1M -type f -print 　　查找等于6字节的文件 $ find . -size 6c -print 　　查找小于32k的文件 $ find . -size -32k -print </code></pre><h4 id="9、执行命令"><a href="#9、执行命令" class="headerlink" title="9、执行命令 　　"></a>9、执行命令 　　</h4><p>​      </p><pre><code>  1）查找 del.txt 并删除，删除前提示确认   $ find . -name &apos;del.txt&apos; -ok rm {} \; 　　 2） 查找 aa.txt 并备份为aa.txt.bak   $ find . -name &apos;aa.txt&apos; -exec cp {} {}.bak \; 3）查当前目录下的所有普通文件# find . -type f -exec ls -l {} \; </code></pre><p>   -rw-r–r–    1 root      root         34928 2003-02-25   ./conf/httpd.conf<br>   -rw-r–r–    1 root      root         12959 2003-02-25   ./conf/magic<br>   -rw-r–r–    1 root      root          180 2003-02-25   ./conf.d/README </p><p>   查当前目录下的所有普通文件，并在 - exec 选项中使用 ls -l 命令将它们列出</p><p>   4）在 /logs 目录中查找更改时间在5日以前的文件并删除它们<br>   $ find logs -type f -mtime +5 -exec   -ok   rm {} ;</p><p>   5）查询当天修改过的文件</p><p>   $ find  ./  -mtime  -1  -type f  -exec  ls -l  {} ; </p><p>   6）查询文件并询问是否要显示</p><pre><code># find   ./   -mtime   -1   -type f   -ok   ls -l   {} \;  &lt; ls … ./classDB.inc.php &gt; ? y-rw-r–r–    1 cnscn    cnscn       13709   1月 12 12:22 ./classDB.inc.php# find   ./   -mtime   -1   -type f   -ok   ls -l   {} \;  &lt; ls … ./classDB.inc.php &gt; ? n</code></pre><p>关于 有没有 -print 的区别</p><h5 id="加-print"><a href="#加-print" class="headerlink" title="加  -print"></a>加  -print</h5><p>查找目录并列出目录下的文件(为找到的每一个目录单独执行ls命令，没有选项-print时文件列表前一行不会显示目录名称)<br>find . -type d -print -exec ls {} ;</p><p><img src="/2019/12/10/linux-find /1.png" alt="img"></p><h5 id="不加-print"><a href="#不加-print" class="headerlink" title="不加 -print"></a>不加 -print</h5><p><img src="/2019/12/10/linux-find /C:%5CUsers%5Clenovo%5Cblog%5Csource_posts%5Clinux-find%5C2.png" alt="img"></p><hr><p>原文链接：<a href="https://blog.csdn.net/l_liangkk/article/details/81294260" target="_blank" rel="noopener">https://blog.csdn.net/l_liangkk/article/details/81294260</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>python语法：for...else...</title>
      <link href="/2018/08/08/python%E8%AF%AD%E6%B3%95%EF%BC%9Afor-else/"/>
      <url>/2018/08/08/python%E8%AF%AD%E6%B3%95%EF%BC%9Afor-else/</url>
      
        <content type="html"><![CDATA[<h2 id="了解for-和-else-语法"><a href="#了解for-和-else-语法" class="headerlink" title="了解for 和 else 语法"></a>了解for 和 else 语法</h2><blockquote><p> 只要for循环完毕，else就会跑一遍。循环被break中段，则不会走else</p></blockquote><h4 id="当for循环能够顺利循环完毕，则最后输出else-并且else能够打印最后一次的输出"><a href="#当for循环能够顺利循环完毕，则最后输出else-并且else能够打印最后一次的输出" class="headerlink" title="当for循环能够顺利循环完毕，则最后输出else,并且else能够打印最后一次的输出"></a>当for循环能够顺利循环完毕，则最后输出else,并且else能够打印最后一次的输出</h4><a id="more"></a><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">5</span>):</span><br><span class="line"></span><br><span class="line">  print(i)</span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line"></span><br><span class="line">  print(i, <span class="string">'我是else'</span>)  <span class="comment"># 可以打印</span></span><br></pre></td></tr></table></figure><p><img src="/2018/08/08/python语法：for-else/1.png" alt="img"></p><h4 id="当for-循环被break时，就不会走到else了"><a href="#当for-循环被break时，就不会走到else了" class="headerlink" title="当for 循环被break时，就不会走到else了"></a>当for 循环被break时，就不会走到else了</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">5</span>):</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> i &gt; <span class="number">2</span>:</span><br><span class="line"></span><br><span class="line">    print(i)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line"></span><br><span class="line">  print(i, <span class="string">'我是else'</span>)<span class="comment"># 打印不出来</span></span><br></pre></td></tr></table></figure><p><img src="/2018/08/08/python语法：for-else/2.png" alt="img"></p><h4 id="continue-不会妨碍else"><a href="#continue-不会妨碍else" class="headerlink" title="continue 不会妨碍else"></a>continue 不会妨碍else</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">5</span>):</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> i &gt; <span class="number">2</span>:</span><br><span class="line"></span><br><span class="line">    print(i)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line"></span><br><span class="line">  print(i, <span class="string">'我是else'</span>)<span class="comment"># 可以打印</span></span><br></pre></td></tr></table></figure><p><img src="/2018/08/08/python语法：for-else/3.png" alt="img"></p>]]></content>
      
      
      <categories>
          
          <category> python语法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python语法 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>*args和**kwargs</title>
      <link href="/2018/08/08/args%E5%92%8C-kwargs/"/>
      <url>/2018/08/08/args%E5%92%8C-kwargs/</url>
      
        <content type="html"><![CDATA[<h4 id="args-kwargs-不定长参数"><a href="#args-kwargs-不定长参数" class="headerlink" title="args  *kwargs  不定长参数"></a><em>args  *</em>kwargs  不定长参数</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">jia</span><span class="params">(*args)</span>:</span></span><br><span class="line">    s = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> args:</span><br><span class="line">        s += i</span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">print(jia(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>))         <span class="comment">#6</span></span><br></pre></td></tr></table></figure><a id="more"></a><blockquote><p>python函数允许同时全部或部分使用使用固定参数，默认参数，单值（一颗星）可变参数，键值对（两颗星）可变参数，使用时必须安装前述顺序书写。</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">info</span><span class="params">(name, age=<span class="number">18</span>, *args, **kwargs)</span>:</span></span><br><span class="line">    print(<span class="string">'姓名:%s,年龄:%d'</span> % (name, age))</span><br><span class="line">    print(args)</span><br><span class="line">    print(kwargs)</span><br><span class="line"></span><br><span class="line">info(<span class="string">'xuefeng'</span>, <span class="number">23</span>, <span class="number">180</span>, <span class="number">80</span>, like=<span class="string">'python'</span>, body=<span class="string">'fat'</span>)</span><br></pre></td></tr></table></figure><p><img src="/2018/08/08/args和-kwargs/1.png" alt="img"></p><blockquote><p>此外一颗星（单值可变参数）和两颗星（键值对可变参数）还可用于列表，元组，字典的解包。</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">a = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line">print(*a)               <span class="comment"># 1 2 3</span></span><br><span class="line">b = (<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">print(*b)               <span class="comment"># 1 2 3</span></span><br><span class="line">c = &#123;<span class="string">'name'</span>: <span class="string">'小明'</span>, <span class="string">'age'</span>: <span class="number">23</span>&#125;</span><br><span class="line">print(*c)               <span class="comment"># name age</span></span><br><span class="line">print(<span class="string">'name:&#123;name&#125;,age:&#123;age&#125;'</span>.format(**c))  <span class="comment"># name:小明,age:23</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Django-DBrouter</title>
      <link href="/2018/08/08/Django-DBrouter/"/>
      <url>/2018/08/08/Django-DBrouter/</url>
      
        <content type="html"><![CDATA[<h2 id="DB-router"><a href="#DB-router" class="headerlink" title="DB-router"></a>DB-router</h2><blockquote><p>通过编写<strong>db-router</strong>可以灵性连接<strong>mysql</strong>主从复制等情况下的多数据库</p></blockquote><ul><li>假设你已经配置好了类似<strong>MYSQL</strong>主从复制的服务，如果没有可以参照<a href="https://lienze.tech/blog/mysql/c813917a.html" target="_blank" rel="noopener">这里</a></li></ul><a id="more"></a><ul><li>settings.py</li></ul><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DATABASES = &#123;    'default': &#123;        'ENGINE': 'django.db.backends.mysql',        'HOST': '192.168.1.101',        'PORT': <span class="number">3306</span>,        'USER': 'root',        'PASSWORD': '<span class="number">123456</span>',        'NAME': 'test1'    &#125;,    'slave': &#123;        'ENGINE': 'django.db.backends.mysql',        'HOST': '192.168.1.102',        'PORT': <span class="number">3306</span>,        'USER': 'root',        'PASSWORD': '<span class="number">123456</span>',        'NAME': 'test1'    &#125;&#125;DATABASE_ROUTERS = ['pro.utils.MasterSlaveDBRouter']</span><br></pre></td></tr></table></figure><ul><li>编写<strong>db-router</strong></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MasterSlaveDBRouter</span>:</span>    <span class="string">"""数据库主从读写分离路由"""</span>    <span class="function"><span class="keyword">def</span> <span class="title">db_for_read</span><span class="params">(self, model, **hints)</span>:</span>        <span class="string">"""读数据库"""</span>        <span class="keyword">return</span> <span class="string">"slave"</span>    <span class="function"><span class="keyword">def</span> <span class="title">db_for_write</span><span class="params">(self, model, **hints)</span>:</span>        <span class="string">"""写数据库"""</span>        <span class="keyword">return</span> <span class="string">"default"</span>    <span class="function"><span class="keyword">def</span> <span class="title">allow_relation</span><span class="params">(self, obj1, obj2, **hints)</span>:</span>        <span class="string">"""是否运行关联操作"""</span>        <span class="keyword">return</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure><ul><li>如出现以下错误，修改主库binlog日志格式</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">django.db.utils.InternalError: (1665, 'Cannot <span class="keyword">execute</span> <span class="keyword">statement</span>: impossible <span class="keyword">to</span> write <span class="keyword">to</span> <span class="built_in">binary</span> <span class="keyword">log</span> since BINLOG_FORMAT = <span class="keyword">STATEMENT</span> <span class="keyword">and</span> <span class="keyword">at</span> <span class="keyword">least</span> one <span class="keyword">table</span> uses a <span class="keyword">storage</span> <span class="keyword">engine</span> limited <span class="keyword">to</span> <span class="keyword">row</span>-based logging. <span class="keyword">InnoDB</span> <span class="keyword">is</span> limited <span class="keyword">to</span> <span class="keyword">row</span>-<span class="keyword">logging</span> <span class="keyword">when</span> <span class="keyword">transaction</span> <span class="keyword">isolation</span> <span class="keyword">level</span> <span class="keyword">is</span> <span class="keyword">READ</span> COMMITTED <span class="keyword">or</span> <span class="keyword">READ</span> UNCOMMITTED.<span class="string">')</span></span><br><span class="line"><span class="string">binlog_format=mixed</span></span><br></pre></td></tr></table></figure><h3 id="打开日志用以分析"><a href="#打开日志用以分析" class="headerlink" title="打开日志用以分析"></a>打开日志用以分析</h3><ul><li>可以通过配置<strong>mysql</strong>日志记录，用以查看主从在读写情况下的效果</li></ul><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">general_log=<span class="number">1</span>general_log_file=<span class="regexp">/var/</span>lib<span class="regexp">/mysql/g</span>eneral.log</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Django </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysql主从复制</title>
      <link href="/2018/08/08/%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/"/>
      <url>/2018/08/08/%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/</url>
      
        <content type="html"><![CDATA[<h2 id="Mysql主从复制"><a href="#Mysql主从复制" class="headerlink" title="Mysql主从复制"></a>Mysql主从复制</h2><ul><li>什么是<strong>主从复制</strong>？</li></ul><blockquote><p>主从复制至少需要两台服务器，或两个<strong>mysql</strong>服务，可以配置一主多从，多主多从</p><p>建立与某个业务数据库一样的数据库环境，即为主从复制</p><p>一般情况下，主库用以写，而从库用以读</p></blockquote><a id="more"></a><ul><li>为什么要搭建主从复制？<ol><li>构建主从热备，当某天数据库宕机或或数据丢失情况，可以有备份数据库继续工作</li><li>降低IO频次，多库之间可以合理分配读写压力，提高单个数据库服务的数据库访问压力</li><li>隔离读写，在某些锁表情况下，可以使数据库读操作继续进行</li></ol></li></ul><blockquote><p>利用数据库<strong>bin-log</strong>二进制文件，该文件包含有数据库操作的所有SQL语句</p><p>复制该文件至其余数据库服务中并执行即可</p></blockquote><ul><li><p>主从复制过程</p><ol><li><p>当主库具有新数据时，主库会被从库请求，建立线程进行连接，用以传输<strong>binlog</strong>日志</p></li><li><p>从库开启两个线程</p><blockquote><p>A线程：也叫做<strong>IO线程</strong>，连接主库，并请求binlog中的更新记录至从库中，写入至从库的<strong>relaylog</strong>文件中</p><p>B线程：也叫做<strong>SQL线程</strong>，读取<strong>relaylog</strong>文件中的更新操作并执行</p></blockquote></li><li><p>如果，有多个从库同时存在，主库会为每个从库建立一个<strong>binlog</strong>输出线程</p></li></ol></li></ul><p>[<img src="/2018/08/08/主从复制/%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E5%8E%9F%E7%90%86%E8%87%AA%E7%BB%98.png" alt="主从复制原理自绘">]</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> validate_password_policy=<span class="keyword">LOW</span>;<span class="keyword">set</span> <span class="keyword">global</span> validate_password_length=<span class="number">6</span>;</span><br></pre></td></tr></table></figure><h3 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h3><blockquote><p>此处以一主一丛为例</p></blockquote><ul><li>系统环境<ul><li>主库（master）：192.168.1.100</li><li>从库（slave）：192.168.1.101</li></ul></li></ul><h3 id="主库修改"><a href="#主库修改" class="headerlink" title="主库修改"></a>主库修改</h3><ul><li>主库配置修改</li></ul><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">server-id = <span class="attribute">1log-bin</span>=mysql-bin # 开启log <span class="attribute">binexpire_logs_days</span>=7 # 日志保存时间</span><br></pre></td></tr></table></figure><blockquote><p><strong>server-id</strong>：</p><p>同步数据中必须包含<strong>server-id</strong>，用于标识该语句最初是从哪个<strong>server</strong>写入</p><p>每个<strong>slave</strong>端只能有一个线程在<strong>master</strong>端连接，如果两个<strong>salve</strong>端的<strong>server-id</strong>一致，一个连接成功之后，前一个连接将会被断开</p><p>主主同步时，避免数据同步陷入死循环</p></blockquote><ul><li>主库创建用户，用以从机连接获取<strong>binlog</strong>日志</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">grant</span> <span class="keyword">replication</span> <span class="keyword">slave</span> <span class="keyword">on</span> *.* <span class="keyword">to</span> <span class="string">'master'</span>@<span class="string">'%'</span> <span class="keyword">identified</span> <span class="keyword">by</span> <span class="string">'123456'</span>;<span class="keyword">flush</span> <span class="keyword">privileges</span>;</span><br><span class="line"><span class="keyword">grant</span> <span class="keyword">all</span> <span class="keyword">privileges</span> <span class="keyword">on</span> *.* <span class="keyword">to</span> <span class="keyword">master</span>@<span class="string">'%'</span> <span class="keyword">identified</span> <span class="keyword">by</span> <span class="string">"123456"</span>;</span><br></pre></td></tr></table></figure><ul><li>查看master状态</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">master</span> <span class="keyword">status</span>;</span><br></pre></td></tr></table></figure><ul><li>记录上条命令返回的<strong>binlog</strong>文件名，<strong>Position</strong>属性，从机连接的时候要用</li></ul><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">+<span class="params">------------------</span>+<span class="params">----------</span>+<span class="params">--------------</span>+<span class="params">------------------</span>+<span class="params">-------------------</span>+| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |+<span class="params">------------------</span>+<span class="params">----------</span>+<span class="params">--------------</span>+<span class="params">------------------</span>+<span class="params">-------------------</span>+| mysql-bin.000001 |      154 |              |                  |                   |+<span class="params">------------------</span>+<span class="params">----------</span>+<span class="params">--------------</span>+<span class="params">------------------</span>+<span class="params">-------------------</span>+1 row in <span class="keyword">set</span> <span class="params">(0.00 sec)</span></span><br></pre></td></tr></table></figure><h3 id="从库修改"><a href="#从库修改" class="headerlink" title="从库修改"></a>从库修改</h3><ul><li>从库配置修改</li></ul><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server-id</span>=<span class="number">11</span></span><br></pre></td></tr></table></figure><blockquote><p><strong>master</strong>与<strong>slave</strong>端的<strong>server-id</strong>不能一样</p><p><strong>salve</strong>端无需开启<strong>log-bin</strong>功能</p></blockquote><ul><li>从库指定master，执行如下</li></ul><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">change master <span class="keyword">to</span> <span class="attribute">master_host</span>=<span class="string">'192.168.1.100'</span>, <span class="attribute">master_port</span>=3306, <span class="attribute">master_user</span>=<span class="string">'master'</span>, <span class="attribute">master_password</span>=<span class="string">'123456'</span>, <span class="attribute">master_log_file</span>=<span class="string">'mysql-bin.000001'</span>, <span class="attribute">master_log_pos</span>=154;</span><br></pre></td></tr></table></figure><ul><li>启动从机</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">start</span> <span class="keyword">slave</span>;</span><br></pre></td></tr></table></figure><h3 id="同步特定的库"><a href="#同步特定的库" class="headerlink" title="同步特定的库"></a>同步特定的库</h3><h4 id="主机处配置"><a href="#主机处配置" class="headerlink" title="主机处配置"></a>主机处配置</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">binlog-do-db</span>=xxxx   # 二进制日志记录的数据库<span class="attribute">binlog-ignore-db</span>=xxxx # 二进制日志中忽略数据库</span><br></pre></td></tr></table></figure><h4 id="从机处配置"><a href="#从机处配置" class="headerlink" title="从机处配置"></a>从机处配置</h4><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">replicate-<span class="keyword">do</span>-<span class="keyword">db</span>    # 设定需要复制的数据库replicate-ignore-<span class="keyword">db</span> # 设定需要忽略的复制数据库replicate-<span class="keyword">do</span>-<span class="keyword">table</span>  # 设定需要复制的表replicate-ignore-<span class="keyword">table</span> # 设定需要忽略的复制表replicate-wild-<span class="keyword">do</span>-<span class="keyword">table</span> # 同replication-<span class="keyword">do</span>-<span class="keyword">table</span>功能一样，但是可以通配符replicate-wild-ignore-<span class="keyword">table</span> # 同replication-ignore-<span class="keyword">table</span>功能一样，但是可以加通配符</span><br></pre></td></tr></table></figure><h3 id="常见错误"><a href="#常见错误" class="headerlink" title="常见错误"></a>常见错误</h3><ul><li><strong>mysql</strong>-&gt;<strong>mariadb</strong>版本问题</li></ul><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Last_IO_Error: Got fatal <span class="keyword">error</span> <span class="number">1236</span> <span class="keyword">from</span> master when reading data <span class="keyword">from</span> binary <span class="built_in">log</span>: 'Client requested master <span class="keyword">to</span> start replication <span class="keyword">from</span> position &gt; <span class="built_in">file</span> size'</span><br></pre></td></tr></table></figure><blockquote><p>从<strong>MySQL5.6</strong>开始引入了<strong>binlog_checksum</strong>全局变量，即<strong>MySQL</strong>会将<strong>event</strong>的<strong>CRC32</strong>校验值也写入<strong>binlog</strong>，显然<strong>MariaDB</strong>在分析日志的时候不会考虑该信息，导致解析出错</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">variables</span> <span class="keyword">like</span> <span class="string">'%binlog%'</span>;</span><br><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> binlog_checksum=<span class="keyword">NONE</span>;</span><br></pre></td></tr></table></figure><ul><li><p>当使用命令show slave status\G;  查看从机与主机的连接状态时，本应该这样：</p><p>​    Slave_IO_Running: Yes</p><p>​    Slave_SQL_Running: Yes    </p><p>​     但是出现了这种情况：</p><p><img src="/2018/08/08/主从复制/%E9%94%99%E8%AF%AF.png" alt="image"></p></li><li><p>处理办法：</p><ul><li>重置mysql数据库 ：systemctl restart mariadb.service</li><li>由此我想到了一个远古的传说：当改变应用程序的配置文件后，先重新启动以保证配置文件生效！！！谨记</li></ul></li></ul>]]></content>
      
      
      <categories>
          
          <category> mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
